<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wsOnpe</a> &gt; <a href="index.source.html" class="el_package">pe.gob.onpe.wsonpe.service</a> &gt; <span class="el_source">LoginService.java</span></div><h1>LoginService.java</h1><pre class="source lang-java linenums">package pe.gob.onpe.wsonpe.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.stereotype.Service;
import pe.gob.onpe.wsonpe.constants.CryptoValues;
import pe.gob.onpe.wsonpe.dto.LoginRequest;
import pe.gob.onpe.wsonpe.dto.MensajeWsResponse;
import pe.gob.onpe.wsonpe.dto.UserResponse;

import pe.gob.onpe.wsonpe.model.TabEleccion;
import pe.gob.onpe.wsonpe.projections.FindConfigurationProjection;
import pe.gob.onpe.wsonpe.repository.TabConfTxRepository;
import pe.gob.onpe.wsonpe.repository.TabEleccionRepository;
import pe.gob.onpe.wsonpe.repository.TabUsuarioRepository;
import pe.gob.onpe.wsonpe.utils.Crypto;
import pe.gob.onpe.wsonpe.utils.WsOnpeUtils;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
<span class="fc" id="L34">@Slf4j</span>
public class LoginService implements ILoginService {

	private final TabUsuarioRepository usuarioRepository;
	private final TabConfTxRepository confTxRepository;
	private final TabEleccionRepository eleccionRepository;

	private static final int ACTIVE = 1;

  @Value(&quot;${stae.trans.jwtLifetime}&quot;)
  private int jwtLifetime;

  @Value(&quot;${stae.trans.refreshJwtLifetime}&quot;)
  private int refreshJwtLifetime;


  public LoginService(TabUsuarioRepository usuarioRepository, TabConfTxRepository confTxRepository,
<span class="fc" id="L51">			TabEleccionRepository eleccionRepository) {</span>
<span class="fc" id="L52">		this.usuarioRepository = usuarioRepository;</span>
<span class="fc" id="L53">		this.confTxRepository = confTxRepository;</span>
<span class="fc" id="L54">		this.eleccionRepository = eleccionRepository;</span>
<span class="fc" id="L55">	}</span>

	@Override
	public MensajeWsResponse login(LoginRequest request) {

<span class="fc" id="L60">		log.info(&quot;login: Acción de login&quot;);</span>

<span class="fc" id="L62">		log.info(&quot;login: Llamando al SP&quot;);</span>
<span class="fc" id="L63">		Map&lt;String, Object&gt; validaAccesoResponse = usuarioRepository.spValidaAcceso(request.getUsuario(),</span>
<span class="fc" id="L64">				WsOnpeUtils.getSHA(request.getClave()));</span>

<span class="fc" id="L66">		Integer codigo = (Integer) validaAccesoResponse.get(&quot;PO_RESULTADO&quot;);</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">		boolean success = codigo == 1;</span>
<span class="fc" id="L68">		String descripcion = (String) validaAccesoResponse.get(&quot;PO_MENSAJE&quot;);</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">		if (!success) {</span>
<span class="fc" id="L71">			log.error(&quot;login: {}, Error de inicio de sesión {}&quot;, request.getUsuario(), descripcion);</span>
<span class="fc" id="L72">			return new MensajeWsResponse(codigo, false, descripcion);</span>
		}

		String token;

		try {
<span class="nc" id="L78">			token = getJwtToken(request.getUsuario(), request.isRefreshToken());</span>
<span class="fc" id="L79">		} catch (Exception e) {</span>
<span class="fc" id="L80">			log.error(&quot;login: Error generando el token. {}&quot;, e.getMessage());</span>
<span class="fc" id="L81">			return new MensajeWsResponse(2, false, &quot;Error generando el token&quot;);</span>
<span class="nc" id="L82">		}</span>

<span class="nc" id="L84">		return dataAuthentication(request.getUsuario(), token, descripcion);</span>
	}

	private MensajeWsResponse dataAuthentication(String usuario, String token, String usuarioPerfil) {

<span class="nc" id="L89">		List&lt;FindConfigurationProjection&gt; opConfTx = confTxRepository.findBynEstado(ACTIVE);</span>
<span class="nc" id="L90">		List&lt;TabEleccion&gt; tabEleccionList = eleccionRepository.findAll();</span>
<span class="nc" id="L91">		List&lt;UserResponse.Elecciones&gt; eleccionesList = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L93" title="All 4 branches missed.">		if (opConfTx == null || opConfTx.isEmpty()) {</span>
<span class="nc" id="L94">			log.warn(&quot;dataAuthentication: No se encontraron registros de configuración&quot;);</span>
<span class="nc" id="L95">			return new MensajeWsResponse(2, false, &quot;No se encontraron registros de configuración&quot;);</span>
		}

<span class="nc" id="L98">		FindConfigurationProjection confTx = opConfTx.getLast();</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (!tabEleccionList.isEmpty()) {</span>
<span class="nc" id="L101">			tabEleccionList.forEach(e -&gt; eleccionesList</span>
<span class="nc" id="L102">					.add(new UserResponse.Elecciones(e.getCEleccionPk(), e.getCNombreCortoEleccion())));</span>
		}

<span class="nc" id="L105">		ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L106">		UserResponse userResponse = new UserResponse(confTx.getCDescripcion(), confTx.getCEncSea(),</span>
<span class="nc" id="L107">				confTx.getCEncFile(), confTx.getNTxMesa(), confTx.getCEncVep(), confTx.getCEncFirma(),</span>
<span class="nc" id="L108">				confTx.getCEncQr(), confTx.getChsqlUsr(), confTx.getChsqlPwd(), eleccionesList, usuarioPerfil, token);</span>
		String data;

		try {
<span class="nc" id="L112">			data = objectMapper.writeValueAsString(userResponse);</span>
<span class="nc" id="L113">		} catch (JsonProcessingException e) {</span>
<span class="nc" id="L114">			log.error(&quot;dataAuthentication: Error parseando json respuesta.&quot;);</span>
<span class="nc" id="L115">			log.error(ExceptionUtils.getMessage(e));</span>
<span class="nc" id="L116">			return new MensajeWsResponse(0, false, &quot;&quot;);</span>
<span class="nc" id="L117">		}</span>

<span class="nc" id="L119">		log.info(&quot;{}, Inicio de sesión exitosa&quot;, usuario);</span>

<span class="nc" id="L121">		return new MensajeWsResponse(1, true, data);</span>

	}

	private String getJwtToken(String username, boolean refreshToken) {
<span class="fc" id="L126">		List&lt;GrantedAuthority&gt; grantedAuthorities = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;ROLE_USER&quot;);</span>

<span class="fc" id="L128">		long min = 60 * 1000L;</span>

<span class="pc bpc" id="L130" title="1 of 2 branches missed.">		long lifetime = refreshToken ? refreshJwtLifetime * min : jwtLifetime * min;</span>

<span class="fc" id="L132">    Map&lt;String, Object&gt; claim = new HashMap&lt;&gt;();</span>
<span class="fc" id="L133">    claim.put(&quot;authorities&quot;, grantedAuthorities.stream().map(GrantedAuthority::getAuthority).collect(Collectors.toList()));</span>
<span class="nc" id="L134">		String subject = Crypto.encryptStringAES(username);</span>

    String token =  Jwts
<span class="nc" id="L137">                .builder()</span>
<span class="nc" id="L138">                .setClaims(claim)</span>
<span class="nc" id="L139">                .setSubject(subject)</span>
<span class="nc" id="L140">                .setIssuedAt(new Date(System.currentTimeMillis()))</span>
<span class="nc" id="L141">                .setExpiration(new Date(System.currentTimeMillis() + lifetime))</span>
<span class="nc" id="L142">                .signWith(SignatureAlgorithm.HS512, CryptoValues.getJwtKey().getBytes())</span>
<span class="nc" id="L143">                .compact();</span>

<span class="nc" id="L145">		return &quot;Bearer &quot; + token;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>